<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>Tane Pacman</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser-arcade-physics.min.js"></script>
    <style type="text/css">
        html,
        body {
            margin: 0px;
            padding: 0px;
            overflow: hidden;
            height: 100%;
            background: #533d8e;
        }
    </style>
</head>

<body>
    <div id="game-container"></div>
    <script type="text/javascript">

        /* ======================
             GLOBAL VARIABLES
        =========================*/
        const numCoins = 4;
        const numEmojis = 4;
        const numGhosts = 5;
        const tahaBarLength = 75;
        const numTimesToGetEachTaha = 5
        const barIncrement = tahaBarLength / numTimesToGetEachTaha

        let speed = 60, vX = 0, vY = 0, prevX = 0, prevY = 0, prevTime = 0;
        let countWairua = 0, countWhanau = 0, countTinana = 0, countHinengaro = 0;
        let heart1, heart2, heart3;
        let belowLayer, worldLayer, aboveLayer, tileset, emptyTiles, pointPositions;
        let map, player, cursors, bell, bell2, dead, hurt, timeout, gameWorld;

        let whanauBarFill, whanauHud, whanauBarContainer, whanauBarEmpty;
        let hinengaroBarFill, hinengaroHud, hinengaroBarContainer, hinengaroBarEmpty;
        let tinanaBarFill, tinanaHud, tinanaBarContainer, tinanaBarEmpty;
        let wairuaBarFill, wairuaHud, wairuaBarContainer, wairuaBarEmpty;

        let joyStick = joyStick2 = { up: false, down: false, left: false, right: false };
        let score = 0, lives = 3, scoreText = null, gameOver = false, gameWon = false;
        let countdownTimer;

        /* ======================
            START PHASER GAME
        =========================*/
        window.onload = function () {
            const config = {
                type: Phaser.AUTO,

                pixelArt: true,
                scale: {
                    mode: Phaser.Scale.FIT,
                    autoCenter: Phaser.Scale.CENTER_BOTH,
                    width: window.innerWidth,
                    height: window.innerHeight
                },
                physics: {
                    default: "arcade",
                    arcade: {
                        gravity: { y: 0 },
                        debug: false
                    }
                },
                scene: [GameIntro, GamePlay, GameOver]
            };
            this.game = new Phaser.Game(config);
            window.focus();
        }

        /* ======================
             GAME INTRO SCENE
        =========================*/
        class GameIntro extends Phaser.Scene {
            constructor() {
                super({
                    key: "game-intro",
                    pack: {
                        files: [
                            {
                                type: "plugin",
                                key: "rexwebfontloaderplugin",
                                url: "https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexwebfontloaderplugin.min.js",
                                start: true,
                            },
                            //   {
                            //     type: "plugin",
                            //     key: "rexVirtualJoystick",
                            //     url: "https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexvirtualjoystickplugin.min.js",
                            //     start: true,
                            //   },
                            {
                                type: "image",
                                key: "tc-logo",
                                url: "https://cdn.glitch.global/d000a9ec-7a88-4c14-9cdd-f194575da68e/all%20white.png?v=1649980778495",
                            },
                        ],
                    },
                });
            }
            // preloads for the intro scene
            preload() {
                //----- loading screen
                var width = this.cameras.main.width;
                var height = this.cameras.main.height;

                // "loading..." text
                var loadingText = this.make.text({
                    x: width / 2,
                    y: height / 2 - 170,
                    text: "Loading...",
                    style: {
                        font: "20px monospace",
                        fill: "#ffffff",
                    },
                });
                loadingText.setOrigin(0.5, 0.5);

                // loading bar
                var progressBar = this.add.graphics();
                var progressBox = this.add.graphics();
                progressBox.fillStyle(0x222222, 0.8);
                progressBox.fillRect(
                    game.config.width / 2 - 320 / 2,
                    game.config.height / 2 - 140,
                    320,
                    50
                );

                // "made by" text
                var madeByText = this.make.text({
                    x: width / 2,
                    y: height / 2 - 40,
                    text: "game by",
                    style: {
                        font: "20px monospace",
                        fill: "#ffffff",
                    },
                });
                madeByText.setOrigin(0.5, 0.5);

                // tai collective logo
                this.add
                    .image(width / 2, height / 2 + 60, "tc-logo")
                    .setDisplaySize(250, 250);



                // font plugin
                this.plugins.get("rexwebfontloaderplugin").addToScene(this);

                this.load.rexWebFont({
                    google: {
                        families: ["Freckle Face", "Finger Paint", "Nosifer"],
                    },
                });

                // fireworks
                this.load.spritesheet("fireworksBlue", "https://cdn.glitch.global/d000a9ec-7a88-4c14-9cdd-f194575da68e/Explosion_Crystals_Blue-sheet.png?v=1649907669760", { frameWidth: 88, frameHeight: 86, });
                this.load.spritesheet("fireworksRocket", "https://cdn.glitch.global/d000a9ec-7a88-4c14-9cdd-f194575da68e/Rocket_Blue.png-sheet.png?v=1649908638368", { frameWidth: 7, frameHeight: 52, });
                this.load.spritesheet("dreamDiamond", "https://cdn.glitch.global/d000a9ec-7a88-4c14-9cdd-f194575da68e/dream-piece.png?v=1650241420024", { frameWidth: 480, frameHeight: 480, });
                this.load.spritesheet("sprites", "assets/tileset.png", { frameWidth: 20, frameHeight: 20, margin: 1, spacing: 1 });
                this.load.spritesheet("tiles-tane", "assets/Hills.png", { frameWidth: 16, frameHeight: 16 });
                this.load.spritesheet("tiles-tane-dirt", "assets/Dirt.png", { frameWidth: 16, frameHeight: 16 });
                this.load.spritesheet("tane-run", "assets/tane-run.png", { frameWidth: 128, frameHeight: 128 });
                this.load.spritesheet("tane-idle", "https://cdn.glitch.com/cd67e3a9-81c5-485d-bf8a-852d63395343%2Ftane-idle.png?v=1606611069685", { frameWidth: 128, frameHeight: 128 }
                );

                this.load.image("tiles", "assets/tileset.png");
                this.load.image("taha-emojis", "assets/taha-emojis.png");

                // taha
                this.load.image("wairua", "assets/wairua.png");
                this.load.image("tinana", "assets/tinana.png");
                this.load.image("hinengaro", "assets/hinengaro.png");
                this.load.image("whanau", "assets/whanau.png");
                // bar
                this.load.image("barContainer", "assets/bar-meterContainer.png");
                this.load.image("barEmpty", "assets/bar-emptyMeter.png");
                this.load.image("barWhanau", "assets/bar-whanau.png");
                this.load.image("barHinengaro", "assets/bar-hinengaro.png");
                this.load.image("barTinana", "assets/bar-tinana.png");
                this.load.image("barWairua", "assets/bar-wairua.png");
                // hearts
                this.load.image("heart", "assets/heart.png");
                this.load.image("heart-empty", "assets/heart-empty.png");


                // this.load.image("tiles-tane", "assets/Hills.png");
                this.load.tilemapTiledJSON("map", "assets/map.json");
                this.load.tilemapTiledJSON("map-tane", "assets/tane-pacman.json");
                this.load.tilemapTiledJSON("map-tane-2", "assets/tane-pacman-v2.json");


                this.load.audio("bell", "assets/ding.mp3");
                this.load.audio("bell2", "assets/ding2.mp3");
                this.load.audio("powerup", "assets/dead.mp3");
                this.load.audio("hurt", "assets/hurt.mp3");
                this.load.audio("score", "assets/score.wav");
                this.load.audio("powerup2", "https://cdn.glitch.global/d000a9ec-7a88-4c14-9cdd-f194575da68e/Retro%20Event%20StereoUP%2002.wav?v=1649892494671");
                this.load.audio("music", "assets/music.mp3");
                this.load.audio("music-maui-the-tutu", "assets/music-maui-the-tutu.mp3");


                // sounds
                this.load.audio("fireworksSound", "https://cdn.glitch.global/d000a9ec-7a88-4c14-9cdd-f194575da68e/fireworks.wav?v=1649910586351");
                this.load.audio("cheer", "https://cdn.glitch.com/cd67e3a9-81c5-485d-bf8a-852d63395343%2Fcheer.wav?v=1609829231162");

                // game over assets preload in intro-scene
                this.load.audio("die", "https://cdn.glitch.global/d000a9ec-7a88-4c14-9cdd-f194575da68e/death_7_sean.mp3?v=1652937752144");
                this.load.audio("end-music", "https://cdn.glitch.com/cd67e3a9-81c5-485d-bf8a-852d63395343%2Fgameover-music.mp3?v=1609829224481");

                this.load.image("kowhaiwhai", "https://cdn.glitch.com/cd67e3a9-81c5-485d-bf8a-852d63395343%2Fkowhaiwhai.png?v=1609829230478");

                // joystick
                this.load.plugin('rexvirtualjoystickplugin', 'https://cdn.jsdelivr.net/npm/phaser3-rex-plugins@1.1.39/dist/rexvirtualjoystickplugin.min.js', true);

                this.load.scenePlugin("rexuiplugin",
                    "https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexuiplugin.min.js",
                    "rexUI",
                    "rexUI"
                );


                //  Load the Google WebFont Loader script
                this.load.script(
                    "webfont",
                    "//ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js"
                );

                // Pre-loader
                this.load.on("progress", function (value) {
                    console.log(value);
                    progressBar.clear();
                    progressBar.fillStyle(0xffffff, 1);
                    progressBar.fillRect(
                        game.config.width / 2 - 300 / 2,
                        game.config.height / 2 - 130,
                        300 * value,
                        30
                    );
                });
                // this.load.on("fileprogress", function (file) {
                //   console.log(file.src);
                // });
                this.load.on("complete", function () {
                    console.log("complete");
                    progressBar.destroy();
                    progressBox.destroy();
                    loadingText.destroy();
                });

            }
            // create for the intro scene
            create() {

                createWorld.call(this);
                newAnimation("yellow", 5, { start: 25, end: 28 }, this);

                // dialog ONE (Using rexUI)
                let dialog1 = this.rexUI.add
                    .dialog({
                        x: gameWorld.x + (gameWorld.width / 2),
                        y: gameWorld.height / 2,
                        width: 200,
                        background: this.rexUI.add.roundRectangle(0, 0, 100, 100, 10, 0x654aad),
                        content: this.createLabel(
                            this,
                            "Navigate the maze and collect “emojis” to fill up each taha.",
                            20,
                            20
                        ),
                        description: this.add
                            .image(0, 0, "taha-emojis").setDisplaySize(300, 100)
                        ,
                        actions: [this.createLabel(this, "NEXT", 10, 10)],
                        space: {
                            left: 20,
                            right: 20,
                            top: 50,
                            bottom: 20,
                            content: 20,
                            toolbarItem: 5,
                            choice: 15,
                            action: 15,
                            // description: 100,
                            descriptionLeft: 150,
                            descriptionRight: 150,
                        },
                        align: {
                            content: "center",
                            description: "center",
                            actions: "right", // 'center'|'left'|'right'
                        },
                        click: {
                            mode: "release",
                        },
                    })
                    .layout()
                    .drawBounds(this.add.graphics(), 0xff0000)
                    .popUp(1000)
                    .setDepth(600);

                // dialog TWO
                let dialog2 = this.rexUI.add
                    .dialog({
                        x: gameWorld.x + (gameWorld.width / 2),
                        y: gameWorld.height / 2,
                        width: 200,
                        background: this.rexUI.add.roundRectangle(0, 0, 100, 100, 20, 0x654aad),
                        content: this.createLabel(
                            this,
                            "Don't get hit by the ghosts!!",
                            20,
                            20
                        ),
                        description: this.add
                            .sprite(0, 0, "sprites")
                            .play("yellow")
                            .setDisplaySize(30, 100),
                        actions: [this.createLabel(this, "START GAME", 10, 10)],
                        space: {
                            left: 20,
                            right: 20,
                            top: 50,
                            bottom: 20,
                            content: 20,
                            toolbarItem: 5,
                            choice: 15,
                            action: 15,
                            description: 50,
                            descriptionLeft: 100,
                            descriptionRight: 100,
                        },
                        align: {
                            content: "center",
                            description: "center",
                            actions: "right", // 'center'|'left'|'right'
                        },
                        click: {
                            mode: "release",
                        },
                    })
                    .layout()
                    //  .drawBounds(this.add.graphics(), 0xff0000)
                    .setVisible(false)
                    .setDepth(600);

                var tween = this.tweens.add({
                    targets: [dialog1, dialog2],
                    scaleX: 1,
                    scaleY: 1,
                    ease: "Bounce", // 'Cubic', 'Elastic', 'Bounce', 'Back'
                    duration: 1000,
                    repeat: 0, // -1: infinity
                    yoyo: false,
                });

                dialog1.on(
                    "button.click",
                    function (button) {
                        if (button.text === "NEXT") {
                            dialog1.setVisible(false);
                            dialog2.setVisible(true).popUp(1000);
                        }
                    },
                    this
                );

                dialog2.on(
                    "button.click",
                    function (button) {
                        if (button.text === "START GAME") {
                            console.log("starting game");
                            // scene.start("game-hud")
                            this.scene.start("game-play");
                        }
                    },
                    this
                );
            }
            // settings for the dialog labels
            // settings for the dialog labels
            createLabel(scene, text, spaceTop, spaceBottom) {
                return scene.rexUI.add.label({
                    width: 40, // Minimum width of round-rectangle
                    height: 40, // Minimum height of round-rectangle
                    background: scene.rexUI.add.roundRectangle(0, 0, 100, 40, 20, 0x8f80b6),
                    text: scene.add
                        .text(0, 0, text, {
                            fontFamily: "Freckle Face",
                            fontSize: "24px",
                            color: "#ffffff",
                        })
                        .setShadow(2, 2, "#333333", 2, false, true)
                        .setAlign("center"),
                    space: {
                        left: 10,
                        right: 10,
                        top: spaceTop,
                        bottom: spaceBottom,
                    },
                });
            }
            update() { }
        }

        /* ======================
            GAME PLAY SCENE   <<---- THIS IS THE ACTUAL GAME
        =========================*/
        class GamePlay extends Phaser.Scene {
            constructor() {
                super({
                    key: "game-play",
                });
            }
            init() {
                // reset global vars
                // countdownTimer = 100;
                speed = 60, vX = 0, vY = 0, prevX = 0, prevY = 0, prevTime = 0;
                countWairua = 0, countWhanau = 0, countTinana = 0, countHinengaro = 0;
                heart1, heart2, heart3;
                belowLayer, worldLayer, aboveLayer, tileset, emptyTiles, pointPositions;
                map, player, cursors, bell, bell2, dead, hurt, timeout, gameWorld;
                whanauBarFill, whanauHud, whanauBarContainer, whanauBarEmpty;
                hinengaroBarFill, hinengaroHud, hinengaroBarContainer, hinengaroBarEmpty;
                tinanaBarFill, tinanaHud, tinanaBarContainer, tinanaBarEmpty;
                wairuaBarFill, wairuaHud, wairuaBarContainer, wairuaBarEmpty;
                joyStick = joyStick2 = { up: false, down: false, left: false, right: false };
                score = 0, lives = 3, scoreText = null, gameOver = false;
                countdownTimer = 100
            }

            preload() {
                this.load.scenePlugin("rexuiplugin",
                    "https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexuiplugin.min.js",
                    "rexUI",
                    "rexUI"
                );
            }

            create() {
                initSounds.call(this);
                createWorld.call(this);
                createAnimations.call(this);
                this.createPlayer.call(this);
                // showScore.call(this);
                createHud.call(this)
                createTimer(this)
                for (let i = 0; i < numCoins; i++) setTimeout(() => createCoin.call(this), Phaser.Math.Between(0, 5000));
                for (let i = 0; i < numEmojis; i++) setTimeout(() => createTaha.call(this), Phaser.Math.Between(0, 5000));
                for (let i = 0; i < numGhosts; i++) setTimeout(() => createGhost.call(this), Phaser.Math.Between(0, 15000));
            }

            update(time, delta) {
                if (gameOver) return;

                // Choose the right animation depending on the player's direction
                if (player.x > prevX) { player.anims.play('taneLeft', true); player.flipX = true; }
                else if (player.x < prevX) { player.anims.play('taneLeft', true); player.flipX = false; }
                else if (player.y > prevY) player.anims.play('taneDown', true);
                else if (player.y < prevY) player.anims.play('taneUp', true);
                else {
                    player.anims.play("taneIdle", true);
                }

                // If the player goes outside the map
                if (player.x < gameWorld.x) player.x = (gameWorld.x + gameWorld.width) - 20;
                else if (player.x > (gameWorld.x + gameWorld.width)) player.x = gameWorld.x;

                let key = player.anims.currentAnim.key;
                let blocked = player.body.blocked;

                // Reset the velocity when the player touches a wall
                if (key == 'right' && blocked.right || key == 'left' && blocked.left) vX = 0;
                if (key == 'up' && blocked.up || key == 'down' && blocked.down) vY = 0;

                // Horizontal movement
                if (cursors.left.isDown || joyStick.left || joyStick2.left) vX = -speed;
                else if (cursors.right.isDown || joyStick.right || joyStick2.right) vX = speed;

                // Vertical movement
                if (cursors.up.isDown || joyStick.up || joyStick2.up) vY = -speed;
                else if (cursors.down.isDown || joyStick.down || joyStick2.down) vY = speed;

                player.setVelocity(vX, vY);

                if ((time - prevTime) > 100) {
                    prevX = player.x;
                    prevY = player.y;
                    prevTime = time;
                }
            }

            createPlayer() {
                // Object layers in Tiled let you embed extra info into a map - like a spawn point or custom
                // collision shapes. In the tmx file, there's an object layer with a point named "Spawn Point"
                const spawnPoint = map.findObject("Spawns", obj => obj.name === "player");

                // Create a sprite with physics enabled via the physics system
                player = this.physics.add.sprite(spawnPoint.x, spawnPoint.y, "taneLeft")
                    .setOrigin(0.5)
                    .setScale(0.4)
                    .setDepth(2)
                // .setDisplaySize(16, 16)
                player.body.setSize(80, 80).setOffset(24, 27);

                // Watch the player and worldLayer for collisions, for the duration of the scene
                this.physics.add.collider(player, worldLayer);

                cursors = this.input.keyboard.createCursorKeys();

                // Show the joysticks only in mobile devices
                if (!this.sys.game.device.os.desktop) {
                    joyStick = this.plugins.get('rexvirtualjoystickplugin').add(this, {
                        x: 80, y: map.heightInPixels - 100, radius: 20,
                        base: this.add.circle(0, 0, 20, 0x888888).setAlpha(0.8).setDepth(4),
                        thumb: this.add.circle(0, 0, 20, 0xcccccc).setAlpha(0.5).setDepth(4)
                    }).on('update', this.update, this);

                    joyStick2 = this.plugins.get('rexvirtualjoystickplugin').add(this, {
                        x: map.widthInPixels - 80, y: map.heightInPixels - 100, radius: 20,
                        base: this.add.circle(0, 0, 20, 0x888888).setAlpha(0.8).setDepth(4),
                        thumb: this.add.circle(0, 0, 20, 0xcccccc).setAlpha(0.5).setDepth(4)
                    }).on('update', this.update, this);
                }
            }

            loadTimer() {
                if (countdownTimer === 0) {
                    console.log("end");
                    this.scene.start("game-over", { deathBy: 'time' });
                } else {
                    countdownTimer -= 1;
                    this.timer.setText("Time: " + countdownTimer);
                }
            }

            launchFireworks() {
                this.sound.play("fireworksSound");
                const bottomOfScreen = gameWorld.height
                const rand1x = Phaser.Math.Between(0, game.config.width);
                const rand1y = Phaser.Math.Between(50, gameWorld.height - 100);
                const rand2x = Phaser.Math.Between(0, game.config.width);
                const rand2y = Phaser.Math.Between(50, gameWorld.height - 100);
                const fireworks = this.add
                    .sprite(rand1x, bottomOfScreen, "fireworksRocket")
                    .setDepth(1006);
                const fireworks1 = this.add
                    .sprite(rand2x, bottomOfScreen, "fireworksRocket")
                    .setDepth(1006);
                fireworks.play("fireworksRocket");
                this.tweens
                    .add({
                        targets: fireworks,
                        y: rand1y,
                        duration: 2000,
                        ease: "Power2",
                    })
                    .on("complete", (anim, frame) => {
                        fireworks.setScale(2);
                        fireworks.play("fireworksBlue");
                    });
                this.tweens
                    .add({
                        targets: fireworks1,
                        y: rand2y,
                        duration: 2500,
                        ease: "Power2",
                    })
                    .on("complete", (anim, frame) => {
                        fireworks1.setScale(2);
                        fireworks1.play("fireworksBlue");
                    });
            }

            createLabel(scene, text, spaceTop, spaceBottom) {
                return scene.rexUI.add.label({
                    width: 40, // Minimum width of round-rectangle
                    height: 40, // Minimum height of round-rectangle
                    background: scene.rexUI.add.roundRectangle(0, 0, 100, 40, 20, 0x8f80b6),
                    text: scene.add
                        .text(0, 0, text, {
                            fontFamily: "Freckle Face",
                            fontSize: "24px",
                            color: "#ffffff",
                        })
                        .setShadow(2, 2, "#333333", 2, false, true)
                        .setAlign("center"),
                    space: {
                        left: 10,
                        right: 10,
                        top: spaceTop,
                        bottom: spaceBottom,
                    },
                });
            }
        }

        /* ======================
             GAME OVER SCENE
        =========================*/
        class GameOver extends Phaser.Scene {
            constructor() {
                super({
                    key: "game-over",
                });
            }
            // propped in data
            init(data) {
                console.log("game over scene started");
                this.deathBy = data.deathBy
            }
            // Game Over scene preload
            preload() {

            }
            // Game Over scene create
            create() {
                // set death message
                let deathMsg = this.deathBy == 'time' ? 'You ran out of time' : 'You were killed by a ghost'

                this.cameras.main.setBackgroundColor("lightgrey");

                // music
                this.scene.stop("game-play");
                this.sound.stopAll();
                this.sound.play("die", { volume: 0.3 });
                // load song
                const musicConfig = {
                    volume: 0.5,
                    loop: true,
                    delay: 3000,
                };
                this.endMusic = this.sound.add("end-music", musicConfig);
                this.endMusic.play();

                const width = this.scale.width;
                const height = this.scale.height;

                this.add
                    .tileSprite(
                        game.config.width / 2,
                        game.config.height / 2 + 500,
                        game.config.width,
                        3000,
                        "kowhaiwhai"
                    )
                    .setScrollFactor(0, 0.25)
                    .setAlpha(0.2)
                    .setScale(1);

                WebFont.load({
                    google: {
                        families: ["Freckle Face", "Finger Paint", "Nosifer"],
                    },
                    active: () => {
                        // game over
                        this.gameOver = this.add
                            .text(
                                gameWorld.x + (gameWorld.width / 2),
                                gameWorld.height / 2 - 100,
                                deathMsg,
                                {
                                    fontFamily: "Freckle Face",
                                    fontSize: 50,
                                    color: "#ffffff",
                                }
                            )
                            .setShadow(2, 2, "#333333", 2, false, true);
                        this.gameOver.setAlign("center");
                        this.gameOver.setOrigin();
                        this.gameOver.setScrollFactor(0);

                        // restart button
                        this.pressRestart = this.add
                            .text(
                                gameWorld.x + (gameWorld.width / 2),
                                gameWorld.height / 2,
                                "Restart Game",
                                {
                                    fontFamily: "Finger Paint",
                                    fontSize: 20,
                                    color: "#ffffff",
                                }
                            )
                            .setShadow(2, 2, "#333333", 2, false, true);
                        this.pressRestart.setAlign("center");
                        this.pressRestart.setOrigin();
                        this.pressRestart.setScrollFactor(0);
                        this.pressRestart.setInteractive()
                        this.pressRestart.on('pointerdown', () => this.scene.start("game-play"));

                        // quit button
                        this.pressQuit = this.add
                            .text(
                                gameWorld.x + (gameWorld.width / 2),
                                gameWorld.height / 2 + 80,
                                "Quit Game",
                                {
                                    fontFamily: "Finger Paint",
                                    fontSize: 20,
                                    color: "#ffffff",
                                }
                            )
                            .setShadow(2, 2, "#333333", 2, false, true);
                        this.pressQuit.setAlign("center");
                        this.pressQuit.setOrigin();
                        this.pressQuit.setScrollFactor(0);
                        this.pressQuit.setInteractive()
                        this.pressQuit.on('pointerdown', () => {
                            //TODO: @FFF quit back to app
                            console.log("quit back to app")
                        });
                    },
                });


            }
        }


        /* ======================
            FUNCTIONS
       =========================*/
        function initSounds() {
            this.sound.stopAll();
            bell = this.sound.add('bell', { volume: 0.2 });
            bell2 = this.sound.add('bell2', { volume: 0.8 });
            point = this.sound.add('score', { volume: 0.8 });
            powerup = this.sound.add('powerup', { volume: 0.7 });
            powerup2 = this.sound.add('powerup2', { volume: 0.7 });
            hurt = this.sound.add('hurt', { volume: 0.9 });
            this.sound.add('music-maui-the-tutu', { volume: 0.4 }).play({ loop: -1 });
        }

        function createWorld() {
            map = this.make.tilemap({ key: "map-tane-2" });

            // Parameters are the name you gave the tileset in Tiled and then the key of the tileset image in
            // Phaser's cache (i.e. the name you used in preload)
            tileset = map.addTilesetImage("Hills", "tiles-tane");
            tilesetDirt = map.addTilesetImage("Dirt", "tiles-tane-dirt");

            // Parameters: layer name (or index) from Tiled, tileset, x, y
            // belowLayer = map.createLayer("Below Player", tileset, 0, 0).setDepth(1);
            dirtLayer = map.createLayer("Dirt", tilesetDirt, 0, 0).setDepth(1);
            worldLayer = map.createLayer("World", tileset, 0, 0).setDepth(2);
            // aboveLayer = map.createLayer("Above Player", tileset, 0, 0).setDepth(3);

            worldLayer.setCollisionByProperty({ collides: true });

            gameWorld = map.findObject("GameCanvas", obj => obj.name === "game");
            console.log("game world:", gameWorld)
            this.physics.world.setBounds(gameWorld.x, gameWorld.y, gameWorld.width, gameWorld.height);

            // from Points layer in Tiled
            emptyTiles = map.getObjectLayer('Points')['objects'];
            // console.log("pointPositions", pointPositions)

            // side areas
            let leftSide = map.findObject("OffCanvas", obj => obj.name === "left");
            let rightSide = map.findObject("OffCanvas", obj => obj.name === "right");
            console.log("leftSide.width:", leftSide.width)
            var graphics = this.add.graphics().setDepth(3);
            graphics.fillStyle(0x533d8e);
            graphics.fillRect(leftSide.x, leftSide.y, leftSide.width, leftSide.height);
            graphics.fillRect(rightSide.x, rightSide.y, rightSide.width, rightSide.height);

            this.cameras.main.roundPixels = true

            this.scale.resize(map.widthInPixels, map.heightInPixels).refresh();
        }

        function newAnimation(name, rate, sprites, context) {
            context.anims.create({
                key: name, frameRate: rate, repeat: -1,
                frames: context.anims.generateFrameNumbers('sprites', sprites),
            });
        }

        function createAnimations() {
            // Player
            newAnimation("left", 10, { start: 51, end: 58 }, this);
            newAnimation("right", 10, { start: 68, end: 75 }, this);
            newAnimation("down", 10, { start: 85, end: 92 }, this);
            newAnimation("up", 10, { start: 102, end: 109 }, this);
            // Point
            newAnimation("point", 1, { start: 8, end: 8 }, this);
            // Coin
            newAnimation("spinning", 10, { start: 0, end: 7 }, this);
            // Fruits
            newAnimation("fruits", 2, { frames: [46, 47, 114, 143] }, this);
            // Ghosts
            newAnimation("blue", 5, { start: 17, end: 20 }, this);
            newAnimation("pink", 5, { start: 21, end: 24 }, this);
            newAnimation("yellow", 5, { start: 25, end: 28 }, this);
            newAnimation("green", 5, { start: 34, end: 37 }, this);
            newAnimation("orange", 5, { start: 38, end: 41 }, this);
            newAnimation("red", 5, { start: 42, end: 45 }, this);
            // Tane
            this.anims.create({
                key: "taneLeft",
                frames: this.anims.generateFrameNumbers("tane-run", {
                    frames: [16, 17, 18, 19, 20, 21, 22, 23],
                }),
                frameRate: 18,
                repeat: -1,
            });
            this.anims.create({
                key: "taneDown",
                frames: this.anims.generateFrameNumbers("tane-run", {
                    frames: [0, 1, 2, 3, 4, 5, 6, 7],
                }),
                frameRate: 18,
                repeat: -1,
            });
            this.anims.create({
                key: "taneUp",
                frames: this.anims.generateFrameNumbers("tane-run", {
                    frames: [8, 9, 10, 11, 12, 13, 14, 15],
                }),
                frameRate: 18,
                repeat: -1,
            });
            this.anims.create({
                key: "taneIdle",
                frames: this.anims.generateFrameNumbers("tane-idle", {
                    frames: [6, 7, 8],
                }),
                frameRate: 5,
            });
            // Taha
            newAnimation("wairua", 1, { start: 1, end: 1 }, this);
            newAnimation("hinengaro", 1, { start: 1, end: 1 }, this);
            newAnimation("tinana", 1, { start: 1, end: 1 }, this);
            newAnimation("whanau", 1, { start: 1, end: 1 }, this);
            this.anims.create({
                key: "fireworksBlue",
                frames: "fireworksBlue",
                frameRate: 30,
            });
            this.anims.create({
                key: "fireworksRocket",
                frames: "fireworksRocket",
                frameRate: 30,
                repeat: -1,
            });
            this.anims.create({
                key: "dreamDiamond",
                frames: "dreamDiamond",
                frameRate: 15,
                repeat: -1,
            });
        }

        function showScore() {
            if (!scoreText) scoreText = this.add.text(map.widthInPixels / 2, map.heightInPixels / 2, '', { fontSize: (18) + 'px', fill: '#FFF' }).setOrigin(0.5, 0).setScrollFactor(0).setDepth(4);
            scoreText.setText('Score:' + score);
        }

        function newObject(animation, context) {
            const tile = Phaser.Utils.Array.GetRandom(emptyTiles);
            return context.physics.add.sprite(tile.x, tile.y, 'sprites').setOrigin(0.5).anims.play(animation, true).setDepth(3);
        }

        function newGhost(animation, context) {
            const spawnPoint = map.findObject("Spawns", obj => obj.name === "enemy");
            return context.physics.add.sprite(spawnPoint.x, spawnPoint.y, 'sprites').setOrigin(0).anims.play(animation, true).setDepth(4).setScale(1.6);
        }

        function createCoin() {
            let coin = newObject('spinning', this);
            coin.body.setAllowGravity(false);
            this.physics.add.overlap(player, coin, collectCoin, null, this);
        }

        function createTaha() {
            // random 1-4 taha
            const tahas = ['wairua', 'hinengaro', 'whanau', 'tinana'];
            const randomTaha = tahas[Phaser.Math.Between(0, tahas.length - 1)]
            // let taha = newObject(randomTaha, this);
            const tile = Phaser.Utils.Array.GetRandom(emptyTiles);
            let taha = this.physics.add.sprite(tile.x, tile.y, randomTaha).setOrigin(0.5).setDepth(3);
            taha.name = randomTaha
            taha.setDisplaySize(32, 32)
            taha.body.setAllowGravity(false);
            this.physics.add.overlap(player, taha, collectTaha, null, this);

        }

        function createGhost() {
            const colors = ['blue', 'pink', 'yellow', 'green', 'orange', 'red'];
            let ghost = newGhost(colors[Phaser.Math.Between(0, colors.length - 1)], this).setCollideWorldBounds(true).setBounce(1);
            ghost.setVelocity(Phaser.Math.Between(speed / 3, speed / 2), Phaser.Math.Between(-speed / 2, -speed / 3)).body.setAllowGravity(false);
            this.physics.add.collider(ghost, worldLayer);
            this.physics.add.collider(ghost, gameWorld);
            this.physics.add.overlap(player, ghost, hitGhost, null, this);
        }

        function powerUp(color) {
            player.setTint(color);
            player.setScale(0.6)
            player.body.setSize(50, 50).setOffset(34, 37);
            speed = 100
            if (timeout) clearTimeout(timeout);
            timeout = setTimeout(() => {
                timeout = false;
                player.clearTint()
                player.setScale(0.4)
                player.body.setSize(80, 80).setOffset(24, 27);
                speed = 60
            }, 5000);
        }

        function collectCoin(player, coin) {
            powerup.play();
            coin.destroy();
            createCoin.call(this);

            score += 10;
            // showScore();

            powerUp(0xFFFF00);
        }

        function collectPoint(player, point) {
            bell.play();
            point.destroy();

            score += 5;
            // showScore();
        }

        function collectTaha(player, taha) {
            // increase count
            switch (taha.name) {
                case "whanau":
                    countWhanau++
                    whanauBarFill.y -= barIncrement
                    if (countWhanau == numTimesToGetEachTaha) {
                        tahaFull(this, whanauHud, whanauBarContainer, whanauBarEmpty, whanauBarFill)
                        return
                    }
                    break;
                case "wairua":
                    countWairua++
                    wairuaBarFill.y -= barIncrement
                    if (countWairua == numTimesToGetEachTaha) {
                        tahaFull(this, wairuaHud, wairuaBarContainer, wairuaBarEmpty, wairuaBarFill)
                        return
                    }
                    break;
                case "tinana":
                    countTinana++
                    tinanaBarFill.y -= barIncrement
                    if (countTinana == numTimesToGetEachTaha) {
                        tahaFull(this, tinanaHud, tinanaBarContainer, tinanaBarEmpty, tinanaBarFill)
                        return
                    }
                    break;
                case "hinengaro":
                    countHinengaro++
                    hinengaroBarFill.y -= barIncrement
                    if (countHinengaro == numTimesToGetEachTaha) {
                        tahaFull(this, hinengaroHud, hinengaroBarContainer, hinengaroBarEmpty, hinengaroBarFill)
                        return
                    }
                    break;
                default:
                    break;
            }

            // score & reset
            point.play();
            taha.destroy();
            createTaha.call(this);
            score += 15;
            // showScore();

            console.log({
                countWhanau: countWhanau,
                countWairua: countWairua,
                countTinana: countTinana,
                countHinengaro: countHinengaro,
            })

            // check if game won
            if (countWhanau >= numTimesToGetEachTaha && countWairua >= numTimesToGetEachTaha && countTinana >= numTimesToGetEachTaha && countHinengaro >= numTimesToGetEachTaha && gameWon == false) {
                gameWon = true
                console.log("you win")
                // less go fireworks!
                // start fireworks
                this.launchFireworks();
                // launch fireworks to the amount of dreams collected
                for (var i = 1; i < (score / 10); i++) { //TODO: make fireworksd relative to remaining time
                    this.time.addEvent({
                        delay: i * 1000,
                        callback: this.launchFireworks,
                        callbackScope: this,
                    });
                }

                // after fireworks - hiwa gives dream piece
                winGame(this)
            }

        }

        function tahaFull(context, hud, container, barEmpty, barFill) {
            container.destroy()
            barEmpty.destroy()
            barFill.destroy()
            powerup2.play()
            var tween = context.tweens.add({
                targets: hud,
                ease: 'Power1',
                y: hud.y - 15,
                scale: 0.3,
                duration: 1000,
                yoyo: true,
                repeat: -1
            });
            var tween = context.tweens.add({
                targets: hud,
                ease: 'Power1',
                rotation: -0.5,
                duration: 500,
                yoyo: true,
                repeat: -1
            });
            var tween = context.tweens.add({
                targets: hud,
                ease: 'Power1',
                rotation: 0.5,
                delay: 500,
                duration: 500,
                yoyo: true,
                repeat: -1
            });
        }

        function hitGhost(player, ghost) {
            // If the player is already hurt, it cannot be hurt again for a while
            if (player.tintTopLeft == 0xFF00FF) return;

            if (timeout) {
                score += 15;
                bell2.play();
            }
            else {
                lives--;
                switch (lives) {
                    case 2:
                        heart3.setTexture('heart-empty')
                        break;
                    case 1:
                        heart2.setTexture('heart-empty')
                        break;
                    case 0:
                        heart1.setTexture('heart-empty')
                        break;
                    case -1:
                        console.log("gameover")
                        gameOver = true
                        this.scene.start("game-over", { deathBy: 'ghost' })
                        break
                    default:
                        break
                }
                hurt.play();
                this.cameras.main.shake(200);
                // protect(0xFF00FF);
                player.setTint(0xFF00FF);
                player.setAlpha(0);
                let tw = this.tweens.add({
                    targets: player,
                    alpha: 1,
                    duration: 200,
                    ease: 'Linear',
                    repeat: 10,
                    onComplete: () => player.clearTint()
                });
            }

            // showScore();

            if (lives == -1) {
                // this.physics.pause();
                // gameOver = true;
                // this.add.image(210, 230, 'restart').setScale(2).setScrollFactor(0).setDepth(4)
                //     .setInteractive().on('pointerdown', () => location.reload());

                // TODO: this.scene.start("game-over")
            }
            else {
                ghost.destroy();
                createGhost.call(this);
            }
        }

        function createHud() {

            // lives
            heart1 = this.add.image(map.widthInPixels / 2 - 25, 25, "heart").setDepth(3).setScale(0.7)
            heart2 = this.add.image(map.widthInPixels / 2, 25, "heart").setDepth(3).setScale(0.7)
            heart3 = this.add.image(map.widthInPixels / 2 + 25, 25, "heart").setDepth(3).setScale(0.7)

            // hud icons
            whanauHud = this.add.image(gameWorld.x + 33, gameWorld.height / 2 - 55, "whanau").setDepth(3).setDisplaySize(20, 20)
            hinengaroHud = this.add.image(gameWorld.x + gameWorld.width - 33, gameWorld.height / 2 - 55, "hinengaro").setDepth(3).setDisplaySize(20, 20)
            tinanaHud = this.add.image(gameWorld.x + 33, gameWorld.height / 2 + 135, "tinana").setDepth(3).setDisplaySize(20, 20)
            wairuaHud = this.add.image(gameWorld.x + gameWorld.width - 33, gameWorld.height / 2 + 135, "wairua").setDepth(3).setDisplaySize(20, 20)

            // // hud values
            // empty bar == 72 full bar == 147 difference == 75
            // empty bar == 38 full bar == 113 difference == 75

            // hud bar containers
            whanauBarContainer = this.add.image(gameWorld.x + 28, gameWorld.height / 2 - 150, "barContainer").setScale(0.15).setOrigin(0).setScrollFactor(0).setDepth(900)
            hinengaroBarContainer = this.add.image(gameWorld.x + gameWorld.width - 38, gameWorld.height / 2 - 150, "barContainer").setScale(0.15).setOrigin(0).setScrollFactor(0).setDepth(900)
            tinanaBarContainer = this.add.image(gameWorld.x + 28, gameWorld.height / 2 + 35, "barContainer").setScale(0.15).setOrigin(0).setScrollFactor(0).setDepth(900)
            wairuaBarContainer = this.add.image(gameWorld.x + gameWorld.width - 38, gameWorld.height / 2 + 35, "barContainer").setScale(0.15).setOrigin(0).setScrollFactor(0).setDepth(900)

            // hud empty bars
            whanauBarEmpty = this.add.image(gameWorld.x + 29, gameWorld.height / 2 - 150, "barEmpty").setScale(0.15).setOrigin(0).setScrollFactor(0).setDepth(900)
            hinengaroBarEmpty = this.add.image(gameWorld.x + gameWorld.width - 37.5, gameWorld.height / 2 - 150, "barEmpty").setScale(0.15).setOrigin(0).setScrollFactor(0).setDepth(900)
            tinanaBarEmpty = this.add.image(gameWorld.x + 29, gameWorld.height / 2 + 35, "barEmpty").setScale(0.15).setOrigin(0).setScrollFactor(0).setDepth(900)
            wairuaBarEmpty = this.add.image(gameWorld.x + gameWorld.width - 37.5, gameWorld.height / 2 + 35, "barEmpty").setScale(0.15).setOrigin(0).setScrollFactor(0).setDepth(900)

            // hud bar fills
            whanauBarFill = this.add.image(gameWorld.x + 30, gameWorld.height / 2 - 72, "barWhanau").setScale(0.15).setOrigin(0).setScrollFactor(0).setDepth(900)
            hinengaroBarFill = this.add.image(gameWorld.x + gameWorld.width - 36, gameWorld.height / 2 - 72, "barHinengaro").setScale(0.15).setOrigin(0).setScrollFactor(0).setDepth(900)
            tinanaBarFill = this.add.image(gameWorld.x + 30, gameWorld.height / 2 + 113, "barTinana").setScale(0.15).setOrigin(0).setScrollFactor(0).setDepth(900)
            wairuaBarFill = this.add.image(gameWorld.x + gameWorld.width - 36, gameWorld.height / 2 + 113, "barWairua").setScale(0.15).setOrigin(0).setScrollFactor(0).setDepth(900)

            // hud bar masks
            whanauBarFill.mask = new Phaser.Display.Masks.BitmapMask(
                this,
                whanauBarEmpty
            );
            hinengaroBarFill.mask = new Phaser.Display.Masks.BitmapMask(
                this,
                hinengaroBarEmpty
            );
            tinanaBarFill.mask = new Phaser.Display.Masks.BitmapMask(
                this,
                tinanaBarEmpty
            );
            wairuaBarFill.mask = new Phaser.Display.Masks.BitmapMask(
                this,
                wairuaBarEmpty
            );
        }

        function createTimer(context) {
            // ====================== timer text =============================
            // load google font
            WebFont.load({
                google: {
                    families: ["Freckle Face", "Finger Paint", "Nosifer"],
                },
                active: () => {
                    context.timer = context.add
                        .text(gameWorld.x + (gameWorld.width / 2), gameWorld.height / 2 - 5, "Time: " + countdownTimer, {
                            fontFamily: "Freckle Face",
                            fontSize: 35,
                            color: "#ffffff",
                        })
                        .setShadow(2, 2, "#333333", 2, false, true);
                    context.timer.setAlign("center");
                    context.timer.setOrigin(0.5);
                    context.timer.setDepth(600);
                    context.timer.setScrollFactor(0);

                    context.gameTimer = context.time.addEvent({
                        delay: 1000, // ms
                        callback: context.loadTimer,
                        //args: [],
                        callbackScope: context,
                        loop: true,
                    });
                },
            });
        }

        function winGame(context) {
            // get all sprites
            let allSprites = context.children.list.filter(x => x instanceof Phaser.GameObjects.Sprite);
            allSprites.forEach(x => {
                console.log("sprite:", x.texture.key)
                // destroy ghost sprites
                if (x.texture.key == "sprites") {
                    x.destroy()
                }
            });
            // stop timer
            context.gameTimer.remove()

            context.sound.play("cheer");

            // center text: https://www.stephengarside.co.uk/blog/phaser-3-center-text-in-middle-of-screen/
            const screenCenterX =
                context.cameras.main.worldView.x + context.cameras.main.width / 2;
            const screenCenterY =
                context.cameras.main.worldView.y + context.cameras.main.height / 2;

            context.dialog4 = context.rexUI.add
                .dialog({
                    x: screenCenterX,
                    y: screenCenterY,
                    width: 200,
                    background: context.rexUI.add.roundRectangle(
                        0,
                        0,
                        100,
                        100,
                        10,
                        0x533d8e
                    ),
                    content: context.createLabel(context, "Taha are fulfilled.\nReceive the final dream piece\nthat completes the Tāne’s moemoea", 20, 20),
                    description: context.add
                        .sprite({
                            x: 0,
                            y: 0,
                            key: "dreamDiamond",
                        })
                        .play("dreamDiamond")
                        .setDisplaySize(150, 150),
                    actions: [context.createLabel(context, "NEXT", 10, 10)],
                    space: {
                        left: 10,
                        right: 10,
                        top: 10,
                        bottom: 20,
                        content: 10,
                        toolbarItem: 5,
                        choice: 15,
                        action: 15,
                        description: 25,
                        descriptionLeft: 100,
                        descriptionRight: 100,
                    },
                    align: {
                        content: "center",
                        description: "center",
                        actions: "center", // 'center'|'left'|'right'
                    },
                    click: {
                        mode: "release",
                    },
                })
                .layout()
                //  .drawBounds(context.add.graphics(), 0xff0000)
                .popUp(1000)
                .setDepth(1003)
                .setScrollFactor(0);

            context.dialog5 = context.rexUI.add
                .dialog({
                    x: screenCenterX,
                    y: screenCenterY,
                    width: 200,
                    background: context.rexUI.add.roundRectangle(
                        0,
                        0,
                        100,
                        100,
                        10,
                        0x533d8e
                    ),
                    content: context.createLabel(context, " What does wellbeing look like to you?\nWhat things will help you fill each of your taha up?", 20, 20),
                    actions: [context.createLabel(context, "DONE", 10, 10)],
                    space: {
                        left: 20,
                        right: 20,
                        top: 50,
                        bottom: 20,
                        content: 20,
                        toolbarItem: 5,
                        choice: 15,
                        action: 15,
                        description: 25,
                        //  descriptionLeft: 200,
                        //  descriptionRight: 200,
                    },
                    align: {
                        content: "center",
                        description: "center",
                        actions: "center", // 'center'|'left'|'right'
                    },
                    click: {
                        mode: "release",
                    },
                })
                .layout()
                //  .drawBounds(context.add.graphics(), 0xff0000)
                .popUp(1000)
                .setDepth(1003)
                .setScrollFactor(0);
            context.dialog5.setVisible(false)



            context.dialog4.on(
                "button.click",
                function (button) {
                    if (button.text === "NEXT") {
                        context.dialog4.setVisible(false);
                        context.dialog5.setVisible(true).popUp(1000);
                    }
                },
                context
            );

            context.dialog5.on(
                "button.click",
                function (button) {
                    if (button.text === "DONE") {
                        console.log("starting game");
                        // TODO: FFF exit game back to app
                        // in meantime restart
                        context.scene.start("game-play");
                    }
                },
                context
            )

        }
    </script>
</body>

</html>